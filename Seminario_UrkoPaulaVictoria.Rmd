---
title: "Seminario Fuentes de datos Biómédicas y Web Semántica"
subtitle: "Relación entre la Esperanza de Vida y el Agua"
author: "Urko Alli Barrena, Paula Gregorio Losada, Victoria Garcia Lovelle"
date: "`r Sys.Date()`"
output: html_document
---
# Introducción
A lo largo del seminario analizaremos de manera formal cómo diversos aspectos relacionados con la calidad y la cantidad de agua consumida pueden afectar en la esperanza de vida en las distintas Comunidades Autónomas de España.

# Objetivos
1. Afectación de la calidad del agua en la Esperanza de Vida
2. Afectación de la cantidad de agua consumida en la Esperanza de Vida
3. Afectación del presupuesto para potabilizar agua con la cantidad de agua consumida
4. Impacto combinado de la calidad y cantidad de agua en la Esperanza de Vida

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE) 
```
## Carga de librerías:

```{r CargaLibrerías, eval = TRUE}
library(pdftools)
library(tidyverse)
library(tidyjson)
library(tidyr)
library(rjson) 
```

## Tabla de Esperanza de Vida:
Para obtener la tabla de esperanza de vida hay que cargar los datos de un archivo Json.

Se crea la importación de los datos Json, después se encuadra el archivo y se observan todos los tipos almacenados en la variable EsperanzaVida.

```{r cargaDeDatosJson}
archivoJson <- fromJSON(file = "EsperanzaVida.json")

esperanzaVida <- spread_all(archivoJson)

# Para cada atributo me dice de qué tipo se trata
tibble1<-esperanzaVida %>% 
  gather_object %>%  
  json_types %>% 
  count(name, type)
```


Para obtener la tabla final se ha accedido a aquel que era de tipo array que contenia los valores de interés.
```{r ObtencionTablaEsperanza,  warning=FALSE}
#Viendo los arrays en el tibble 1, entro en el array Data, de éste puedo obtener el valor de la esperanza de vida, los años y el nombre de las comunidades Autónomas
arrayData<-esperanzaVida %>%
  enter_object(Data) %>% 
  gather_array %>% 
  spread_all %>% 
  select(Nombre, Anyo, Valor) 
```

El atributo Nombre contiene una cadena de caracteres muy largo separados por puntos. Entre toda la información está el nombre de la comunidad autónoma, por lo que se separa la cadena de texto y se obtiene únicamente estos nombres. 

```{r, eval = TRUE,warning=FALSE}
partes <- strsplit(arrayData$Nombre, "\\.")

comunidadesAutonomas<-c()
for (i in partes){
  comunidadesAutonomas<-c(comunidadesAutonomas,i[1])
}

arrayData$Nombre<-comunidadesAutonomas
```

De la tabla se obtiene el año 2020 de cada comunidad autónoma y se obtiene como valor la media de la esperanza de vida en ese año.

Para tener todas las tablas con el mismo estilo, se han pasado los nombres de las comunidades autónomas a mayúsculas.
```{r obtenciontablaEsperanza}
tablaComunidadesAñoValor<- as_tibble(arrayData)
attr(tablaComunidadesAñoValor, "JSON") <- NULL

tablaEsperanzaDeVida <- tablaComunidadesAñoValor %>%
  filter(Anyo==2020)%>%
  group_by(Anyo, Nombre) %>%
  summarize(EsperanzaDeVida = mean(Valor, na.rm = TRUE))%>%
  rename(Año=Anyo,ComunidadAutonoma=Nombre)

tablaEsperanzaDeVidaFinal <- tablaEsperanzaDeVida %>%
  mutate(ComunidadAutonoma = toupper(ComunidadAutonoma))

colnames(tablaEsperanzaDeVidaFinal) <- c("Anio", "ComunidadAutonoma", "EsperanzaDeVida")
```


```{r tablaEsperanza}
tablaEsperanzaDeVidaFinal
```

## Tabla de Cantidad de Agua:
Para obtener la tabla de la cantidad de agua hay que cargar los datos de un archivo Json.

Se crea la importación de los datos Json, después se encuadra el archivo y se observan todos los tipos de atributos almacenados en la variable EsperanzaVida
```{r CargaDatosCantidad}
archivoJsonCantidad <- fromJSON(file = "CantidadAgua.json")

cantidadAgua <- spread_all(archivoJsonCantidad)

#Veo los tipos de atributos
cantidadAgua%>%
  gather_object%>%
  json_types%>%
  count(name,type)
```


Para poder obtener la tabla final de la cantidad de agua consumida en cada comunidad autónoma, se ha accedido al atributo de tipo array que contiene la información de interés que es Data.

Seguidamente, como únicamente necesitamos las comunidades autónomas y están escritas en una larga cadena de texto, dividimos la cadena de texto y obtenemos de ella el nombre de las comunidades autónomas.

Esa nueva variable con las comunidades autónomas se añaden a la tabla final y se elimina donde ponga España.
```{r tablaCantidadAgua}
#Entro en el array Data
arrayDataCantidad<-cantidadAgua%>%
  enter_object(Data)%>%
  gather_array%>%
  spread_all%>%
  select(-document.id,-array.index)

#Divido la cadena de texto nombre y solo cojo las comunidades autónomas
cadenas <- strsplit(arrayDataCantidad$Nombre, "\\,")

#Obtengo las comunidades autónomas
comunidadesAutonomasCantidad<-c()
for (i in cadenas){
  comunidadesAutonomasCantidad<-c(comunidadesAutonomasCantidad,i[1])
}

#Cambio la columna nombre por la columna de las comunidades autónomas
arrayDataCantidad$Nombre<-comunidadesAutonomasCantidad

#Tengo que eliminar de la tabla las comunidades autónomas donde ponga españa
tabla <- arrayDataCantidad %>%
  filter(!(Nombre == "España")) %>%
  select(Nombre, NombrePeriodo, Valor)

```

Se filtra únicamente por el año 2020, que es el año de interés, se realiza una media de los valores obtenidos en el año 2020 de cada comunicad autónoma.

Para tener todas las tablas con el mismo estilo, se han pasado los nombres de las comunidades autónomas a mayúsculas y se han renombrado.

Por último se ha pasado a tipo entero la columna años.
```{r, eval = TRUE,warning=FALSE }
#Agrupo por comunidades autónomas y años
tablaCantidadDeAgua <- tabla %>%
  filter(NombrePeriodo  ==2020)%>%
  group_by(NombrePeriodo  , Nombre) %>%
  summarize(Cantidad = mean(Valor, na.rm = TRUE))%>%
  rename(Año=NombrePeriodo,ComunidadAutonoma=Nombre)

tablaCantidadDeAgua <- tablaCantidadDeAgua %>%
  mutate(ComunidadAutonoma = toupper(ComunidadAutonoma))

tablaCantidadDeAgua[4,2] <- c("BALEARS, ILLES")
tablaCantidadDeAgua[8,2] <- c("CASTILLA - LA MANCHA")
tablaCantidadDeAgua[14,2] <- c("MADRID, COMUNIDAD DE")
tablaCantidadDeAgua[15,2] <- c("MURCIA, REGIÓN DE")
tablaCantidadDeAgua[16,2] <- c("NAVARRA, COMUNIDAD FORAL DE")
tablaCantidadDeAgua[18,2] <- c("RIOJA, LA")

colnames(tablaCantidadDeAgua) <- c("Anio", "ComunidadAutonoma", "Cantidad")

tablaCantidadDeAguaFinal <- tablaCantidadDeAgua %>%
  mutate_at(vars(Anio), as.integer)

```
En la tabla final de la cantidad de agua, se puede observar la cantidad de agua consumida por cada comunidad autónoma en el año 2020.
```{r tablaFinal}

tablaCantidadDeAguaFinal

```


## Tabla de calidad de agua
```{r cargaDatosCalidadDeAgua}
ruta_pdf <- pdf_text("report_Cap.3_part2._Libro_blanco_del_agua.pdf")
pagina <- ruta_pdf[17]
lineas <- strsplit(pagina, "\n")[[1]]
linea_deseada <- lineas[5:21] 
```

```{r tablaCalidadDeAgua}
datos_divididos <- strsplit(linea_deseada, "\\s+")
datos_obtenidos <- datos_divididos[-c(1:3)]

datosDeInteres <- datos_obtenidos[-c(length(datos_obtenidos))]
datosDeInteres[[4]] <- c("CASTILLA - LA MANCHA","28","39","43","24","7","12","0")
datosDeInteres[[5]] <- c("CASTILLA Y LEÓN","2","2","2","0","1","1","0")
datosDeInteres[[9]] <- c("MADRID, COMUNIDAD DE","6","6","7","0","2","5","0")
datosDeInteres[[10]] <- c("MURCIA, REGIÓN DE","3","3","3","0","0","3","0")
datosDeInteres[[11]] <- c("NAVARRA, COMUNIDAD FORAL DE","11","11","11","4","5","2","0")
datosDeInteres[[12]] <- c("RIOJA, LA","1","1","1","0","1","0","0")
datosDeInteres[[13]] <- c("COMUNITAT VALENCIANA","2","2","2","0","1","1","0")

tablaCalidadDeAgua<-data.frame()
for (i in datosDeInteres){
  tablaCalidadDeAgua<-rbind(tablaCalidadDeAgua,i)
}

colnames(tablaCalidadDeAgua) <- c("ComunidadAutonoma", "NumdeMunicipios", "ZonasdeBaño","PuntosdeMuestreo","Aguas2", "Aguas1","Aguas0", "AguasSCF")

colNumericas <- c("NumdeMunicipios", "ZonasdeBaño","PuntosdeMuestreo","Aguas2", "Aguas1","Aguas0", "AguasSCF")
tablaCalidadDeAguaFinal <- tablaCalidadDeAgua %>%
  mutate_at(vars(colNumericas), as.integer)

tablaCalidadDeAguaFinal
```

```{r cargaPresupuesto}
summodificado <- read_csv("summodificado.csv")
colnames(summodificado) <- c("TotalNacional", "ComunidadAutonoma", "GruposDeUsuarioEImporte","Anio", "Presupuesto")

tablaPresupuestos <- summodificado%>%
  filter(GruposDeUsuarioEImporte=="Importe total de la inversión en los servicios de suministro" & Anio== "2020") %>%
  mutate(ComunidadAutonoma = gsub("^\\d+\\s*", "", ComunidadAutonoma)) %>%
  mutate(ComunidadAutonoma = toupper(ComunidadAutonoma)) %>%
  select (.data = ., Anio, ComunidadAutonoma:Presupuesto) %>%
  drop_na()

tablaPresupuestos$Presupuesto <- gsub("\\.", "", tablaPresupuestos$Presupuesto)
tablaPresupuestos$Presupuesto <- as.integer(tablaPresupuestos$Presupuesto)
tablaPresupuestosFinal <- tablaPresupuestos[,-3]

tablaPresupuestosFinal
```






