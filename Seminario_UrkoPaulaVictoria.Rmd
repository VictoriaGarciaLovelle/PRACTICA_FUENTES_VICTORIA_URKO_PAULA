---
title: "Seminario Fuentes de datos Biómédicas y Web Semántica"
author: "Urko Alli Barrena, Paula Gregorio Losada, Victoria Garcia Lovelle"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '6'
subtitle: Relación entre la Esperanza de Vida y el  consumo de Agua
---

![](escudo_ubu.jpg)

# Introducción

En el desarrollo de este seminario, analizaremos cómo diversos aspectos relacionados con la calidad y cantidad de agua consumida pueden influir en la esperanza de vida en las diferentes Comunidades Autónomas de España.

Exploraremos detalladamente cómo la calidad del agua, medida a través de diferentes parámetros, y la cantidad de agua, pueden ser factores determinantes para la salud y, consecuentemente, para la esperanza de vida de las Comunidades Autónomas.

# Objetivos

Este estudio tiene como objetivo examinar a fondo las conexiones entre los factores medioambientales y la salud humana, centrándonos específicamente en el papel crucial del agua como recurso esencial.

1.  Afectación de la calidad del agua en la Esperanza de Vida
2.  Afectación de la cantidad de agua consumida en la Esperanza de Vida
3.  Afectación del presupuesto para potabilizar agua con la cantidad de agua consumida
4.  Impacto combinado de la calidad y cantidad de agua en la Esperanza de Vida

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE) 
```

# Carga de librerías

1.  pdftools: Esta librería se utilizó para extraer datos de archivos PDF. En particular, se empleó para obtener información relevante sobre la calidad del agua de un informe en formato PDF.

```{r CargaLibrerías, eval = TRUE}
library(pdftools)
```

2.  tidyverse: Un conjunto de paquetes que facilitan la manipulación y visualización de datos en R. Incluye librerías como tidyr y dplyr, las cuales fueron esenciales para organizar y transformar datos.

```{r cargatidyverse}
library(tidyverse)
```

3.  tidyjson: Esta librería fue útil para trabajar con datos en formato JSON. Fue esencial para analizar y extraer información de archivos JSON relacionados con la esperanza de vida y la cantidad de agua.

```{r cargatidyjson}
library(tidyjson)
```

4.  rjson: Se utilizó para cargar y procesar datos almacenados en formato JSON. Facilita la manipulación de datos estructurados y su conversión a formatos compatibles con R.

```{r cargarjson}
library(rjson) 
```

# Obtención de tablas

### 1. Tabla de Esperanza de Vida

Para obtener la tabla de esperanza de vida se cargan los datos desde un archivo Json.

Después organizan esos datos en un formato de tabla y realiza un análisis para saber qué tipos contiene la variable EsperanzaVida.

```{r cargaDeDatosJson}
archivoJson <- fromJSON(file = "EsperanzaVida.json")

esperanzaVida <- spread_all(archivoJson)

tibble1<-esperanzaVida %>% 
  gather_object %>%  
  json_types %>% 
  count(name, type)
```

Para obtener la tabla final se ha accedido a aquel que era de tipo array que contiene los valores de interés y organiza estos datos en una tabla.

```{r ObtencionTablaEsperanza,  warning=FALSE}
arrayData<-esperanzaVida %>%
  enter_object(Data) %>% 
  gather_array %>% 
  spread_all %>% 
  select(Nombre, Anyo, Valor) 
```

El atributo Nombre contiene una cadena de caracteres muy larga separada por puntos. Entre toda la información estan los nombres de las diferentes Comunidades Autónomas, por lo que se separa la cadena de texto y se obtienen únicamente estos nombres.

```{r, eval = TRUE,warning=FALSE}
partes <- strsplit(arrayData$Nombre, "\\.")

comunidadesAutonomas<-c()
for (i in partes){
  comunidadesAutonomas<-c(comunidadesAutonomas,i[1])
}

arrayData$Nombre<-comunidadesAutonomas
```

De la tabla se obtiene el año 2020 de cada Comunidad Autónoma y se obtiene como valor la media de la esperanza de vida en ese año.

Para tener todas las tablas con el mismo estilo, se han pasado los nombres de las comunidades autónomas a mayúsculas.

```{r obtenciontablaEsperanza}
tablaComunidadesAñoValor<- as_tibble(arrayData)
attr(tablaComunidadesAñoValor, "JSON") <- NULL

tablaEsperanzaDeVida <- tablaComunidadesAñoValor %>%
  filter(Anyo==2020)%>%
  group_by(Anyo, Nombre) %>%
  summarize(EsperanzaDeVida = mean(Valor, na.rm = TRUE))%>%
  rename(Año=Anyo,ComunidadAutonoma=Nombre)

tablaEsperanzaDeVidaFinal <- tablaEsperanzaDeVida %>%
  mutate(ComunidadAutonoma = toupper(ComunidadAutonoma))

colnames(tablaEsperanzaDeVidaFinal) <- c("Anio", "ComunidadAutonoma", "EsperanzaDeVida")
```

En la tabla final, se puede observar la media de la esperanza de vida de cada Comunidad Autónoma en el año 2020.

```{r tablaEsperanza}
tablaEsperanzaDeVidaFinal
```

### 2. Tabla de la Cantidad de Agua

Para obtener la tabla de cantidad de agua se cargan los datos desde un archivo Json.

Después organizan esos datos en un formato de tabla y realiza un análisis para saber qué tipos contiene la variable EsperanzaVida.

```{r CargaDatosCantidad}
archivoJsonCantidad <- fromJSON(file = "CantidadAgua.json")

cantidadAgua <- spread_all(archivoJsonCantidad)

cantidadAgua%>%
  gather_object%>%
  json_types%>%
  count(name,type)
```

Para poder obtener la tabla final de la cantidad de agua consumida en cada Comunidad autónoma, se ha accedido al atributo de tipo array que contiene la información de interés que es Data y organiza estos datos en una tabla.

Seguidamente, como únicamente necesitamos las comunidades autónomas y están escritas en una larga cadena de texto, dividimos la cadena de texto y obtenemos de ella el nombre de las Comunidades Autónomas.

Esa nueva variable con las Comunidades Autónomas se añaden a la tabla final y se elimina donde ponga España.

```{r tablaCantidadAgua}
arrayDataCantidad<-cantidadAgua%>%
  enter_object(Data)%>%
  gather_array%>%
  spread_all%>%
  select(-document.id,-array.index)

cadenas <- strsplit(arrayDataCantidad$Nombre, "\\,")

comunidadesAutonomasCantidad<-c()
for (i in cadenas){
  comunidadesAutonomasCantidad<-c(comunidadesAutonomasCantidad,i[1])
}

arrayDataCantidad$Nombre<-comunidadesAutonomasCantidad

tabla <- arrayDataCantidad %>%
  filter(!(Nombre == "España")) %>%
  select(Nombre, NombrePeriodo, Valor)

```

Se filtra únicamente por el año 2020, que es el año de interés, se realiza una media de los valores obtenidos en el año 2020 de cada comunicad autónoma.

Para tener todas las tablas con el mismo estilo, se han pasado los nombres de las Comunidades Autónomas a mayúsculas y se han renombrado.

Por último se ha pasado a tipo entero la columna años.

```{r, eval = TRUE,warning=FALSE }
tablaCantidadDeAgua <- tabla %>%
  filter(NombrePeriodo  ==2020)%>%
  group_by(NombrePeriodo  , Nombre) %>%
  summarize(Cantidad = mean(Valor, na.rm = TRUE))%>%
  rename(Año=NombrePeriodo,ComunidadAutonoma=Nombre)

tablaCantidadDeAgua <- tablaCantidadDeAgua %>%
  mutate(ComunidadAutonoma = toupper(ComunidadAutonoma))

tablaCantidadDeAgua[4,2] <- c("BALEARS, ILLES")
tablaCantidadDeAgua[8,2] <- c("CASTILLA - LA MANCHA")
tablaCantidadDeAgua[14,2] <- c("MADRID, COMUNIDAD DE")
tablaCantidadDeAgua[15,2] <- c("MURCIA, REGIÓN DE")
tablaCantidadDeAgua[16,2] <- c("NAVARRA, COMUNIDAD FORAL DE")
tablaCantidadDeAgua[18,2] <- c("RIOJA, LA")

colnames(tablaCantidadDeAgua) <- c("Anio", "ComunidadAutonoma", "Cantidad")

tablaCantidadDeAguaFinal <- tablaCantidadDeAgua %>%
  mutate_at(vars(Anio), as.integer)

```

En la tabla final de la cantidad de agua, se puede observar la cantidad de agua consumida por cada Comunidad Autónoma en el año 2020.

```{r tablaFinal}
tablaCantidadDeAguaFinal

```

### 3. Tabla de la Calidad del Agua

Este código extrae y procesa información relevante sobre la calidad del agua de un informe en PDF.

Primero, convierte el contenido del PDF a texto y luego selecciona un rango específico de líneas en una página particular del documento, con el objetivo de obtener datos clave relacionados con la calidad del agua.

```{r cargaDatosCalidadDeAgua}
ruta_pdf <- pdf_text("report_Cap.3_part2._Libro_blanco_del_agua.pdf")
pagina <- ruta_pdf[17]
lineas <- strsplit(pagina, "\n")[[1]]
linea_deseada <- lineas[5:21] 
```

En este código se dividen las líneas deseadas usando espacios como delimitadores. Luego, crea dos conjuntos de datos: datos_obtenidos, excluyendo las primeras tres dimensiones no necesarias, y datosDeInteres, que contiene la información esencial sobre las comunidades autónomas y los valores de la calidad del agua.

Además, se añaden manualmente filas específicas que no se extrajeron correctamente del informe.

```{r tablaCalidadDeAgua}
datos_divididos <- strsplit(linea_deseada, "\\s+")
datos_obtenidos <- datos_divididos[-c(1:3)]

datosDeInteres <- datos_obtenidos[-c(length(datos_obtenidos))]
datosDeInteres[[4]] <- c("CASTILLA - LA MANCHA","28","39","43","24","7","12","0")
datosDeInteres[[5]] <- c("CASTILLA Y LEÓN","2","2","2","0","1","1","0")
datosDeInteres[[9]] <- c("MADRID, COMUNIDAD DE","6","6","7","0","2","5","0")
datosDeInteres[[10]] <- c("MURCIA, REGIÓN DE","3","3","3","0","0","3","0")
datosDeInteres[[11]] <- c("NAVARRA, COMUNIDAD FORAL DE","11","11","11","4","5","2","0")
datosDeInteres[[12]] <- c("RIOJA, LA","1","1","1","0","1","0","0")
datosDeInteres[[13]] <- c("COMUNITAT VALENCIANA","2","2","2","0","1","1","0")
```

En cada iteración del bucle, se agrega la fila representada por el elemento i al data frame tablaCalidadDeAgua utilizando la función rbind().

Por último se renombra y se cambia a tipo numérico a aquellas columnas que sea necesario.

```{r calidad}
tablaCalidadDeAgua<-data.frame()
for (i in datosDeInteres){
  tablaCalidadDeAgua<-rbind(tablaCalidadDeAgua,i)
}

colnames(tablaCalidadDeAgua) <- c("ComunidadAutonoma", "NumdeMunicipios", "ZonasdeBaño","PuntosdeMuestreo","Aguas2", "Aguas1","Aguas0", "AguasSCF")

colNumericas <- c("NumdeMunicipios", "ZonasdeBaño","PuntosdeMuestreo","Aguas2", "Aguas1","Aguas0", "AguasSCF")
tablaCalidadDeAguaFinal <- tablaCalidadDeAgua %>%
  mutate_at(vars(colNumericas), as.integer)

```

```{r tablafinalCalidad}
tablaCalidadDeAguaFinal
```

### 4. Tabla de Presupuesto para la Potabilización del Agua

Para obtener esta tabla se ha importado un archivo CSV utilizando la función *read_csv* y después se renombran las columnas para tener unificados todos los nombres de las diferentes tablas.

```{r cargaPresupuesto}
summodificado <- read_csv("summodificado.csv")
colnames(summodificado) <- c("TotalNacional", "ComunidadAutonoma", "GruposDeUsuarioEImporte","Anio", "Presupuesto")
```

Se realizan una serie de modificaciones para poder obtener la tabla deseada.

Se seleccionan las filas donde la columna "GruposDeUsuarioEImporte" es igual a "Importe total de la inversión en los servicios de suministro" y la columna "Anio" es igual a "2020".

Delante de cada nombre de la Comunidad Autónoma existe un número por lo que se elimina y se convierten los nombres de las comunidades a mayúsculas.

Se eliminan los puntos de la columna presupuesto y se pasa a tipo entero. Y por último se descarta lo que no es necesario.

```{r tablaPresupuesto}
tablaPresupuestos <- summodificado%>%
  filter(GruposDeUsuarioEImporte=="Importe total de la inversión en los servicios de suministro" & Anio== "2020") %>%
  mutate(ComunidadAutonoma = gsub("^\\d+\\s*", "", ComunidadAutonoma)) %>%
  mutate(ComunidadAutonoma = toupper(ComunidadAutonoma)) %>%
  select (.data = ., Anio, ComunidadAutonoma:Presupuesto) %>%
  drop_na()

tablaPresupuestos$Presupuesto <- gsub("\\.", "", tablaPresupuestos$Presupuesto)
tablaPresupuestos$Presupuesto <- as.integer(tablaPresupuestos$Presupuesto)
tablaPresupuestosFinal <- tablaPresupuestos[,-3]
```

Asi obtenemos los datos de los presupuesto para la potabilización del agua en el año 2020 en las diferentes Comunidades Autónomas de España

```{r tablaFinalPresupuesto}
tablaPresupuestosFinal
```

# Joins de tablas y sus correspondientes gráficas

En este aparatado realizamos uan cantidad de cuatro joins, los cuaes explicaremos a continuación.

### **1. Relación entre esperanza de vida y cantidad**

```{r EsperanzayCantidad}
EsperanzayCantidad<- tablaEsperanzaDeVidaFinal%>%
  left_join(x=., y=tablaCantidadDeAguaFinal, by=c("Anio","ComunidadAutonoma"))%>%
  group_by(ComunidadAutonoma) %>%
  drop_na()
EsperanzayCantidad
```

En el fragmento de código anterior, unimos mediante un *left_join( )* las tablas de "tablaEsperanzaDeVidaFinal" y "tablaCantidadDeAguaFinal" mediante la columna "Anio" y "ComunidadAutonoma" ordenado en función de las Comunidades Autónomas.

```{r grafEsperanzaCantidad}
grafEsperanzaCantidad <- ggplot(data=EsperanzayCantidad, aes(x=Cantidad, y=EsperanzaDeVida))+
  geom_point(aes(color=ComunidadAutonoma))+
  geom_smooth()+
  labs(title="Cantidad de agua junto esperanza de vida por Comunidades Autonomas",
       x="Cantidad de agua ",
       y="Esperanza de vida")+
  theme_minimal()
grafEsperanzaCantidad
```

Como podemos observar en esta caja de código, creamos la gráfica de la nueva tabla "EsperanzayCantidad" creada a partir del *left_join( )* anterior. En el eje de las abscisas encontramos la cantidad de agua consumida y en el eje de las ordenadas encontramos la esperanza de vida. Como podemos comprobar en la leyenda, gracias a la función *geom_point(aes(color=ComunidadAutonoma))* cada comunidad será representada en la gráfica por un color perteneciente al gradiente y en forma de círculo. Con la funcion *geom_smooth()* creamos la línea de tendencia, ya que tenemos un gráfico de dispersión y así podemos entender el patrón que estamos estudiando con esta gráfica.

Nuestro principal objetivo es determinar la esperanza de vida. En esta tabla relacionamos la esperanza de vida con la cantidad de agua que se consume en cada Comunidad Autónoma. Podemos observar que no hay una relación directamente proporcional entre la cantidad de agua consumida y la esperanza de vida de cada Comunidad Autónoma. Comprobamos en el Anexo 1 \ref{anexo} que las Islas Baleares se encuentra en la undécima posición en cuanto al consumo de agua y en primer lugar en cuanto a la esperanza de vida. Por otro lado, Andalucía está situada en el primer puesto en cuanto a la cantidad de agua que consumen y en el decimotercero en lo que respecta a la esperanza de vida. Aun así, como podemos comprobar a continuación, la línea de tendencia de nuestro gráfico muestra que los extremos no son buenos y que los ciudadanos con una esperanza de vida potencialmente buena son aquellos que consumen una cantidad intermedia de agua.

### 2. Relación entre cantidad y presupuesto

# Anexo 1

\label{anexo}

Orden de la tabla EsperanzayCantidad de mayor a menor en funcion a:

-   La esperanza de vida

```{r EsparanzaVidaMayorMenor}
EsparanzaVidaMayorMenor <- EsperanzayCantidad[order(-EsperanzayCantidad$EsperanzaDeVida), ]
EsparanzaVidaMayorMenor
```

-   La cantidad de agua consumida

```{r CantidaAguaMayorMenor}
CantidadAguaMayorMenor <- EsperanzayCantidad[order(-EsperanzayCantidad$Cantidad), ]
CantidadAguaMayorMenor
```
